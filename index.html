<!DOCTYPE html>
<html>
<head>
    <title>GLOBAL TRACK SYS: Cyber Warfare Command Center V2.1</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* =================================================================== */
        /* I. CORE VARIABLES & BASE STYLES - üé® COLOR PALETTE (Line 18 - 80)  */
        /* =================================================================== */
        :root {
            /* Color Definitions */
            --bg-dark: #000000;         /* True Black, ultimate contrast */
            --bg-medium: #0c141c;       /* Panel/Header Background (Deep Blue-Black) */
            --bg-light: #1a2430;        /* Section Background (Dark Blue-Gray) */
            --accent-blue: #00ffff;     /* Vibrant Cyan (Primary UI Glow/Text) */
            --accent-green: #39ff14;    /* Neon Green (Status OK/Secondary Accent) */
            --text-light: #ffffff;      /* Pure White/Default Text */
            --text-medium: #a0f0f0;     /* Light cyan/teal for secondary text */
            --border-glow: rgba(0, 255, 255, 0.4); /* Cyan glow intensity */
            --box-shadow-glow: rgba(0, 255, 255, 0.2);
            --error-red: #ff3366;       /* Critical Alert/Threat Color */
            
            /* Sizing & Geometry */
            --font-size-base: 14px;
            --border-radius-base: 4px;
        }

        /* Essential Scroll Fix: Allow content to push body height and enable scrolling */
        html {
            height: 100%;
            scroll-behavior: smooth;
        }
        body {
            background: var(--bg-dark);
            color: var(--text-light);
            font-family: 'Montserrat', Arial, sans-serif;
            margin: 0;
            min-height: 100vh; /* Ensure minimum full height */
            display: -webkit-box;
            display: -ms-flexbox;
            display: flex;
            -webkit-box-orient: vertical;
            -webkit-box-direction: normal;
            -ms-flex-direction: column;
            flex-direction: column;
            font-size: var(--font-size-base);
            line-height: 1.4;
        }

        /* Typography & Element Customization */
        h1, h2, h3, h4, .orbitron {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-blue);
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
            margin-top: 0;
            margin-bottom: 0;
        }
        .header-text {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9em;
            color: var(--text-medium);
            letter-spacing: 0.5px;
        }
        .value.orbitron {
             font-weight: 700;
        }
        
        /* =================================================================== */
        /* II. LAYOUT AND GRID - üìê STRUCTURE & POSITIONING (Line 82 - 140)   */
        /* =================================================================== */

        .header-top-bar {
            background: var(--bg-medium);
            padding: 5px 20px;
            border-bottom: 2px solid var(--accent-blue);
            box-shadow: 0 0 10px var(--border-glow);
            display: flex;
            flex-direction: column;
            user-select: none;
            position: sticky; /* Sticky header for better UX */
            top: 0;
            z-index: 100;
        }
        .top-nav { 
            display: flex; justify-content: space-between; align-items: center; 
            font-size: 0.8em; padding-bottom: 5px; 
            border-bottom: 1px solid var(--bg-light); 
        }
        .top-nav-left, .top-nav-right { display: flex; gap: 15px; align-items: center; }
        .top-nav-left span, .top-nav-right span { 
            cursor: pointer; color: var(--text-medium); transition: color 0.2s; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .top-nav-left span:hover, .top-nav-right span:hover { 
            color: var(--accent-blue);
            text-shadow: 0 0 5px var(--accent-blue); 
        }
        .logo-section { display: flex; justify-content: space-between; align-items: center; padding-top: 5px; }
        .logo { 
            font-size: 1.5em; font-weight: 700; color: var(--accent-blue); 
            text-shadow: 0 0 8px var(--accent-blue); margin-right: 20px; 
        }
        .time-markers { display: flex; flex-grow: 1; justify-content: space-around; text-align: center; font-size: 0.9em; color: var(--text-medium); }
        .time-marker span { display: block; }
        .time-marker .location { color: var(--accent-blue); }
        .time-marker .time-value { font-family: 'Orbitron', sans-serif; font-weight: 400; }
        
        .dashboard-container {
            flex-grow: 1;
            display: grid;
            /* Defined Grid Areas: sidebar | map/map | sidebar | radar | lower-right | sidebar | lower-left | lower-right */
            grid-template-areas: 
                "sidebar map map"
                "sidebar radar lower-right"
                "sidebar lower-left lower-right";
            grid-template-columns: 320px 1fr 380px;
            grid-template-rows: 2fr 1fr 220px; /* Crucial: This defines the height of the three main rows */
            gap: 15px;
            padding: 15px;
            box-sizing: border-box;
        }

        /* =================================================================== */
        /* III. PANEL & WIDGET STYLES - üñºÔ∏è COSMETIC & DETAILING (Line 142 - 350) */
        /* =================================================================== */
        
        .panel {
            background: var(--bg-medium);
            border-radius: var(--border-radius-base);
            border: 1px solid var(--border-glow);
            box-shadow: 0 0 10px var(--box-shadow-glow);
            padding: 15px;
            position: relative;
            overflow: hidden;
            transition: box-shadow 0.3s ease, transform 0.1s ease;
        }
        .panel:hover {
            box-shadow: 0 0 20px var(--border-glow);
            transform: scale(1.005);
            z-index: 2;
        }
        .panel-header {
            font-family: 'Orbitron', sans-serif;
            color: var(--accent-blue);
            font-size: 1.1em;
            margin-bottom: 15px;
            border-bottom: 1px dashed rgba(0, 255, 255, 0.4);
            padding-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .sidebar {
            /* This column should be able to scroll independently if content is too tall */
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* Optional: Add a shadow to suggest separation from map */
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.5); 
        }
        .sidebar .section {
            background: var(--bg-light);
            border: 1px solid rgba(0, 255, 255, 0.2);
            padding: 12px;
            border-radius: var(--border-radius-base);
            transition: border-color 0.3s ease;
        }
        .sidebar .section:hover {
            border-color: var(--accent-blue);
        }

        /* Scrollbar Customization - High Detail */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-medium);
            border-radius: 10px;
            -webkit-box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); /* Inner shadow for depth */
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 10px;
            border: 2px solid var(--bg-medium);
            -webkit-transition: background 0.3s;
            -o-transition: background 0.3s;
            transition: background 0.3s;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-green); /* Hover color change */
        }

        /* NETWORK TRAFFIC & MICRO-BARS - Detailed Grid and Colors */
        .network-traffic-display li {
            font-size: 0.8em;
            display: grid;
            grid-template-columns: 2fr 1fr 3fr;
            padding: 4px 0;
            align-items: center;
            color: var(--text-medium);
        }
        .network-traffic-display .label {
            letter-spacing: 0.5px;
        }
        .network-traffic-display .value {
            color: var(--accent-green);
            text-shadow: 0 0 2px var(--accent-green);
        }
        .data-bar {
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-left: 10px;
            position: relative;
        }
        .data-bar::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            box-shadow: inset 0 0 3px rgba(0, 0, 0, 0.5); /* Depth for bar container */
        }
        .data-fill {
            height: 100%;
            background: var(--accent-blue);
            transition: width 0.8s ease-out;
            box-shadow: 0 0 5px var(--accent-blue); /* Glow on the fill */
        }
        .data-fill.green { 
            background: var(--accent-green);
            box-shadow: 0 0 5px var(--accent-green);
        }
        .data-fill.red { 
            background: var(--error-red);
            box-shadow: 0 0 5px var(--error-red);
        }

        /* RADAR BUTTON GROUP STYLING */
        .btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .btn-group .small-btn {
            background: rgba(0, 255, 255, 0.1); border: 1px solid var(--accent-blue); color: var(--accent-blue);
            padding: 5px 10px; border-radius: 3px; font-size: 0.8em; cursor: pointer; position: relative;
            overflow: hidden; transition: all 0.2s ease;
        }
        /* Advanced Shimmer Hover Effect */
        .btn-group .small-btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.2); transition: left 0.3s; transform: skewX(-30deg);
        }
        .btn-group .small-btn:hover::before { left: 100%; }
        .btn-group .small-btn.active {
            background: var(--accent-blue); color: var(--bg-dark); box-shadow: 0 0 15px var(--accent-blue);
        }
        
        /* Analysis status log in the sidebar (New UI Element) */
        .log-display {
            background: var(--bg-light);
            border: 1px solid var(--accent-green);
            border-radius: 3px;
            height: 150px;
            overflow-y: scroll;
            margin-top: 15px;
            padding: 10px;
            font-size: 0.75em;
            white-space: pre-wrap;
            color: var(--text-medium);
            font-family: monospace;
        }
        .log-message.error { color: var(--error-red); }
        .log-message.success { color: var(--accent-green); }


        /* =================================================================== */
        /* IV. MAP STYLING - üó∫Ô∏è B&W CLARITY ADJUSTMENTS (Line 352 - 380)       */
        /* =================================================================== */
        
        .main-map { 
            grid-area: map; display: flex; flex-direction: column; 
        }
        #map {
            flex-grow: 1;
            background-color: var(--bg-dark);
            border: 2px solid var(--accent-blue);
            overflow: hidden;

            /* THE STARK BLACK AND WHITE FILTER FOR CLARITY */
            filter: grayscale(100%) brightness(50%) contrast(150%);
            /* Overlay the cyan tint for cyber look */
            mix-blend-mode: luminosity; /* Maintains B&W clarity */
            background-image: radial-gradient(circle at center, rgba(0,255,255,0.05) 0%, var(--bg-dark) 80%);
        }
        .leaflet-container { background-color: var(--bg-dark) !important; }
        .leaflet-control-zoom-in, .leaflet-control-zoom-out {
            background-color: var(--bg-medium) !important; color: var(--accent-blue) !important;
            border: 1px solid var(--accent-blue) !important;
        }

        /* Map Coordinates Readout Styling */
        .map-coords { 
            display: flex; justify-content: space-around; padding-top: 10px; 
            font-size: 0.8em; color: var(--text-medium); 
            border-top: 1px dotted rgba(0, 255, 255, 0.2); 
            margin-top: 5px;
        }

        /* =================================================================== */
        /* V. RADAR, GAUGES, AND LOWER PANELS (Line 382 - 480)                 */
        /* =================================================================== */
        
        .radar-display { grid-area: radar; padding: 15px; position: relative; }
        .radar-header { color: var(--accent-green); }
        .radar-screen { 
            width: 100%; height: 100%; 
            background: radial-gradient(circle at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 60%, var(--bg-medium) 100%);
            border-radius: 50%; position: relative; display: flex; justify-content: center; align-items: center;
            overflow: hidden;
            border: 1px solid var(--accent-green); /* Radar ring in green */
            box-shadow: 0 0 15px var(--accent-green);
        }
        .radar-line {
            position: absolute; top: 50%; left: 50%; width: 50%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent-green));
            transform-origin: 0% 50%; animation: radarScan 4s linear infinite;
        }
        .radar-dot {
            position: absolute; width: 8px; height: 8px; background-color: var(--accent-green);
            border-radius: 50%; box-shadow: 0 0 10px var(--accent-green), 0 0 20px rgba(0,255,255,0.5);
            animation: pulse 1.5s infinite alternate;
        }
        .radar-dot.threat {
            background-color: var(--error-red); box-shadow: 0 0 10px var(--error-red), 0 0 20px var(--error-red);
        }
        
        /* GAUGES ENHANCEMENT */
        .lower-left-panel { 
            grid-area: lower-left; display: grid; 
            grid-template-columns: repeat(4, 1fr); gap: 10px; 
            align-content: start; 
        }
        .gauge-section { position: relative; text-align: center; }
        .gauge-circle {
            width: 100px; height: 100px; border-radius: 50%; border: 5px solid rgba(0, 255, 255, 0.1);
            margin: 0 auto 5px; position: relative; transform: rotate(45deg); 
        }
        .gauge-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', sans-serif;
            color: var(--text-light);
            font-size: 0.8em;
            text-shadow: 0 0 5px var(--accent-blue);
            z-index: 10;
        }
        .gauge-inner-bg {
             position: absolute; top: 5px; left: 5px; width: 90px; height: 90px; border-radius: 50%; background: var(--bg-medium);
        }
        .gauge-section h5 { margin-top: 10px; margin-bottom: 5px; font-size: 0.75em; color: var(--text-medium); text-transform: uppercase; }
        .gauge-section .value { font-family: 'Orbitron', sans-serif; font-size: 1.1em; }

        /* Aircraft Track / Signal Transmission */
        .lower-right-panel { grid-area: lower-right; display: grid; grid-template-rows: 1fr 1fr; gap: 15px; }
        .plane-visual i { animation: pulse-shadow 2s infinite alternate; color: var(--accent-green); font-size: 3em; }
        .flight-data ul { list-style: none; padding: 0; margin: 0; font-size: 0.9em; }
        .flight-data li { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px dotted rgba(0, 255, 255, 0.1); }
        .signal-block h4 { font-size: 1em; margin-bottom: 5px; }
        .signal-wave { width: 150px; height: 30px; background: linear-gradient(90deg, transparent, var(--accent-green), transparent); position: relative; overflow: hidden; }

        /* =================================================================== */
        /* VI. BUTTONS AND ANIMATIONS (Line 482 - 550)                         */
        /* =================================================================== */
        
        .neon-btn {
            font-size: 1em; background: linear-gradient(90deg, var(--accent-blue), var(--accent-green)); color: var(--bg-dark);
            border: none; border-radius: 6px; box-shadow: 0 0 12px var(--accent-blue); padding: 10px 24px;
            cursor: pointer; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.3s ease; font-weight: 700;
        }
        .neon-btn:hover { box-shadow: 0 0 20px var(--accent-blue), 0 0 30px var(--accent-green); transform: translateY(-2px); }
        .stop-btn { background: linear-gradient(90deg, var(--error-red), #ff8c00) !important; box-shadow: 0 0 12px var(--error-red); }
        .stop-btn:hover { box-shadow: 0 0 20px var(--error-red), 0 0 30px #ff8c00; }

        /* Keyframes Animations */
        @keyframes pulse-shadow { 0% { text-shadow: 0 0 5px var(--accent-green); } 100% { text-shadow: 0 0 15px var(--accent-green), 0 0 25px var(--accent-blue); } }
        @keyframes radarScan { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(1.2); opacity: 0.7; } }
        @keyframes wave-scan { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }

    </style>
</head>
<body>
    <div class="header-top-bar">
        <div class="top-nav">
            <div class="top-nav-left">
                <span><i class="fas fa-file"></i> File</span>
                <span><i class="fas fa-eye"></i> View</span>
                <span><i class="fas fa-search"></i> Search</span>
                <span><i class="fas fa-database"></i> Database</span>
                <span><i class="fas fa-info-circle"></i> Help</span>
            </div>
            <div class="top-nav-right">
                <i class="fas fa-bell" style="color: var(--error-red);"></i>
                <span class="header-text">ACTIVE USER: SQ-48531</span>
                <span><i class="fas fa-cog"></i> SETTINGS</span>
                <span class="header-text" style="color: var(--accent-blue);">LAYOUT 2</span>
                <input type="text" placeholder="Search Data..." style="background: var(--bg-light); border: 1px solid var(--accent-blue); color: var(--text-light); padding: 3px 5px; border-radius: 2px;">
            </div>
        </div>
        <div class="logo-section">
            <div class="logo">GLOBAL TRACK SYS</div>
            <div class="time-markers">
                <div class="time-marker"><span class="location">LOS ANGELES</span><span class="time-value" id="time_LA"></span></div>
                <div class="time-marker"><span class="location">LONDON</span><span class="time-value" id="time_LDN"></span></div>
                <div class="time-marker"><span class="location">MOSCOW</span><span class="time-value" id="time_MSK"></span></div>
                <div class="time-marker"><span class="location">TOKYO</span><span class="time-value" id="time_TKY"></span></div>
                <div class="time-marker"><span class="location">SYDNEY</span><span class="time-value" id="time_SYD"></span></div>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        
        <div class="sidebar panel">
            <div class="panel-header">System Controls & Status</div>
            <button class="neon-btn" onclick="startAnalysis()">START ANALYSIS</button>
            <button class="neon-btn stop-btn" onclick="stopAnalysis()">STOP ANALYSIS</button>
            
            <div class="section">
                <h4><i class="fas fa-stream"></i> ANALYSIS LOGS</h4>
                <div class="log-display" id="analysis_log">
                    <span class="log-message">Awaiting command...</span>
                </div>
            </div>

            <div class="section">
                <h4><i class="fas fa-network-wired"></i> NETWORK TRAFFIC</h4>
                <div class="network-traffic-display">
                    <ul>
                        <li>
                            <span class="label">INBOUND:</span> 
                            <span class="value orbitron" id="inbound_val">0 MB</span>
                            <div class="data-bar"><div class="data-fill blue" style="width: 0%;"></div></div>
                        </li>
                        <li>
                            <span class="label">OUTBOUND:</span> 
                            <span class="value orbitron" id="outbound_val">0 MB</span>
                            <div class="data-bar"><div class="data-fill green" style="width: 0%;"></div></div>
                        </li>
                        <li>
                            <span class="label">THREATS BLOCKED:</span> 
                            <span class="value orbitron" id="threats_val" style="color: var(--error-red);">0</span>
                            <div class="data-bar"><div class="data-fill red" style="width: 0%;"></div></div>
                        </li>
                        <li>
                            <span class="label">TOR NODES:</span> 
                            <span class="value orbitron" id="tor_val">0</span>
                            <div class="data-bar"><div class="data-fill blue" style="width: 0%;"></div></div>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="section">
                <h4><i class="fas fa-satellite-dish"></i> RADAR ROUTER</h4>
                <div class="btn-group" id="router_buttons">
                    <button class="small-btn active" data-mode="LIVE" onclick="toggleMode(this)">LIVE</button>
                    <button class="small-btn" data-mode="REPLAY" onclick="toggleMode(this)">REPLAY</button>
                    <button class="small-btn" data-mode="ARCHIVE" onclick="toggleMode(this)">ARCHIVE</button>
                </div>
                <p style="font-size:0.8em; margin-top: 15px;">SCAN RANGE: <span class="value orbitron">5000 KM</span></p>
                <p style="font-size:0.8em;">STATUS: <span class="value orbitron" id="radar_status">INACTIVE</span></p>
            </div>

            <div class="section">
                <h4><i class="fas fa-globe-americas"></i> CONTINENTAL SCANNING</h4>
                <div class="btn-group" id="continent_buttons">
                    <button class="small-btn" onclick="toggleContinent(this)">N. AMERICA</button>
                    <button class="small-btn active" onclick="toggleContinent(this)">EUROPE</button>
                    <button class="small-btn" onclick="toggleContinent(this)">ASIA</button>
                    <button class="small-btn" onclick="toggleContinent(this)">AFRICA</button>
                    <button class="small-btn" onclick="toggleContinent(this)">S. AMERICA</button>
                    <button class="small-btn" onclick="toggleContinent(this)">OCEANIA</button>
                </div>
            </div>
        </div>

        <div class="main-map panel" style="padding: 10px;">
            <div class="panel-header" style="margin-bottom: 5px; padding-bottom: 5px;">GLOBAL TRACK MAP</div>
            <div id="map"></div>
            <div class="map-coords">
                <span>LAT: <span class="orbitron" id="map_lat">23.456</span></span>
                <span>LON: <span class="orbitron" id="map_lon">-78.901</span></span>
                <span>ZOOM: <span class="orbitron" id="map_zoom">4X</span></span>
            </div>
        </div>
        
        <div class="radar-display panel">
            <div class="radar-header">Live Threat Radar</div>
            <div class="radar-screen">
                </div>
        </div>

        <div class="lower-left-panel panel">
            <div class="gauge-section">
                <div class="gauge-circle" style="background: conic-gradient(var(--accent-green) 0deg, transparent 0deg);" id="gauge_bw_fill">
                    <div class="gauge-inner-bg"></div>
                </div>
                <span class="gauge-text" id="gauge_bw_text">0%</span>
                <h5>BANDWIDTH</h5>
                <span class="value orbitron" style="color: var(--accent-green);">OFFLINE</span>
            </div>
            <div class="gauge-section">
                <div class="gauge-circle" style="background: conic-gradient(var(--accent-blue) 0deg, transparent 0deg);" id="gauge_cpu_fill">
                    <div class="gauge-inner-bg"></div>
                </div>
                <span class="gauge-text" id="gauge_cpu_text">0%</span>
                <h5>CPU LOAD</h5>
                <span class="value orbitron" style="color: var(--accent-blue);">OFFLINE</span>
            </div>
            <div class="gauge-section">
                <div class="gauge-circle" style="background: conic-gradient(var(--error-red) 0deg, transparent 0deg);" id="gauge_mem_fill">
                    <div class="gauge-inner-bg"></div>
                </div>
                <span class="gauge-text" id="gauge_mem_text">0%</span>
                <h5>MEMORY</h5>
                <span class="value orbitron" style="color: var(--error-red);">OFFLINE</span>
            </div>
            <div class="gauge-section">
                <div class="gauge-circle" style="background: conic-gradient(var(--accent-green) 0deg, transparent 0deg);" id="gauge_lat_fill">
                    <div class="gauge-inner-bg"></div>
                </div>
                <span class="gauge-text" id="gauge_lat_text">0MS</span>
                <h5>LATENCY</h5>
                <span class="value orbitron" style="color: var(--accent-green);">OFFLINE</span>
            </div>
        </div>

        <div class="lower-right-panel">
            <div class="panel">
                <div class="panel-header" style="font-size: 0.9em; margin-bottom: 5px; padding-bottom: 5px;"><i class="fas fa-plane"></i> AIRCRAFT TRACK</div>
                <div class="aircraft-track-content">
                    <div class="flight-data">
                        <span class="header-text">FLIGHT 025</span>
                        <ul>
                            <li><span class="label">CALLSIGN:</span> <span class="orbitron">UFA87</span></li>
                            <li><span class="label">FROM:</span> <span class="orbitron">MOSCOW</span></li>
                            <li><span class="label">TO:</span> <span class="orbitron">NEW YORK</span></li>
                            <li><span class="label">EST. TIME:</span> <span class="orbitron">8:14 PM</span></li>
                        </ul>
                    </div>
                    <div class="plane-visual">
                        <i class="fas fa-plane"></i>
                    </div>
                </div>
            </div>
            <div class="panel">
                <div class="panel-header" style="font-size: 0.9em; margin-bottom: 5px; padding-bottom: 5px;"><i class="fas fa-signal"></i> SIGNAL TRANSMISSION</div>
                <div class="signal-transmission-content">
                    <div class="signal-block">
                        <h4>STATUS</h4>
                        <span class="value orbitron" style="color: var(--accent-green);">OFFLINE</span>
                    </div>
                    <div class="signal-wave"></div>
                    <div class="signal-block">
                        <h4>TX RATE</h4>
                        <span class="value orbitron" style="color: var(--accent-blue);">0 GHZ</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="background: var(--bg-medium); color: var(--text-medium); padding: 5px 20px; font-size: 0.7em; border-top: 1px solid var(--accent-blue);">
        <i class="fas fa-terminal" style="color: var(--accent-green);"></i> &nbsp;SYSTEM READY | STATUS: <span id="system_status">INITIALIZED</span> | LAST REFRESH: <span id="last_refresh">--</span>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // ===================================================================
        // JAVASCRIPT: BACKEND COMMUNICATION & DYNAMIC DATA 
        // ===================================================================

        // 1. GLOBAL STATE MANAGEMENT AND UTILITIES
        let analysisRunning = false;
        let radarInterval = null;
        let dataSimulationInterval = null;
        let markerInterval = null;
        
        const minutesToMs = (offsetMinutes) => offsetMinutes * 60000;
        const log = document.getElementById('analysis_log');

        /**
         * Appends a message to the analysis log.
         * @param {string} msg 
         * @param {string} type - 'info', 'success', or 'error'
         */
        function writeLog(msg, type = 'info') {
            const date = new Date().toLocaleTimeString();
            const p = document.createElement('div');
            p.classList.add('log-message', type);
            p.textContent = `[${date}] ${msg}`;
            log.appendChild(p);
            // Auto-scroll to bottom
            log.scrollTop = log.scrollHeight; 
        }

        // 2. LEAFLET MAP INITIALIZATION AND CONTROLS
        var map = L.map('map', {
            zoomControl: false,
            dragging: true 
        }).setView([20, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 18,
            minZoom: 2,
            noWrap: true,
            tileSize: 256,
            detectRetina: true
        }).addTo(map);

        L.control.zoom({ position: 'topright' }).addTo(map);

        var blinkingMarker = L.circleMarker([50.0, -20.0], { 
            radius: 8,
            fillColor: 'red', 
            color: 'var(--accent-blue)', 
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
        }).addTo(map);

        /** Animates the threat marker visibility. */
        function animateMarker() {
            if (!analysisRunning) return;
            const newOpacity = blinkingMarker.options.fillOpacity === 0.8 ? 0.2 : 0.8;
            blinkingMarker.setStyle({fillOpacity: newOpacity});
        }
        markerInterval = setInterval(animateMarker, 800); 

        // 3. REAL-TIME CLOCK MANAGEMENT
        const TIMEZONE_CONFIG = {
            'LA': { offset: -7 * 60, element: 'time_LA' }, 
            'LDN': { offset: 1 * 60, element: 'time_LDN' }, 
            'MSK': { offset: 3 * 60, element: 'time_MSK' }, 
            'TKY': { offset: 9 * 60, element: 'time_TKY' }, 
            'SYD': { offset: 11 * 60, element: 'time_SYD' }
        };

        function updateClocks() {
            try {
                const now = new Date();
                const utc = now.getTime() + minutesToMs(now.getTimezoneOffset());
                
                for (const [key, config] of Object.entries(TIMEZONE_CONFIG)) {
                    const localTimeMs = utc + minutesToMs(config.offset);
                    const localTime = new Date(localTimeMs);
                    
                    const formattedTime = localTime.toLocaleTimeString('en-US', {
                        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true
                    });
                    document.getElementById(config.element).textContent = formattedTime;
                }
            } catch (error) {
                console.error("Error updating clocks:", error.message);
            }
        }
        setInterval(updateClocks, 1000);
        updateClocks(); 

        // 4. RADAR AND DATA SIMULATION FUNCTIONS

        /** Simulates a single, dynamic data refresh cycle for all dashboard metrics. */
        function simulateDataRefresh() {
            if (!analysisRunning) return;

            // Gauge Simulation (for inner text and status)
            const bw_val = Math.floor(Math.random() * 100);
            const cpu_val = Math.floor(Math.random() * 90 + 5);
            const lat_val = Math.floor(Math.random() * 120 + 50);
            const mem_val = Math.floor(Math.random() * 90 + 5);
            const degree = (val) => (val * 360) / 100;

            document.getElementById('gauge_bw_text').textContent = `${bw_val}%`;
            document.getElementById('gauge_cpu_text').textContent = `${cpu_val}%`;
            document.getElementById('gauge_lat_text').textContent = `${lat_val}MS`;
            document.getElementById('gauge_mem_text').textContent = `${mem_val}%`;

            document.getElementById('gauge_bw_fill').style.background = `conic-gradient(var(--accent-green) ${degree(bw_val)}deg, transparent ${degree(bw_val)}deg)`;
            document.getElementById('gauge_cpu_fill').style.background = `conic-gradient(var(--accent-blue) ${degree(cpu_val)}deg, transparent ${degree(cpu_val)}deg)`;
            document.getElementById('gauge_mem_fill').style.background = `conic-gradient(var(--error-red) ${degree(mem_val)}deg, transparent ${degree(mem_val)}deg)`;
            // Latency conversion for display (e.g., 50ms is good, 120ms is bad -> inverse scale for 360 degree)
            const lat_percent = Math.max(0, 100 - (lat_val - 50)); 
            document.getElementById('gauge_lat_fill').style.background = `conic-gradient(var(--accent-green) ${degree(lat_percent)}deg, transparent ${degree(lat_percent)}deg)`;
        }

        /** Generates and places simulated dots on the radar screen. */
        function updateRadarDots() {
            const radarScreen = document.querySelector('.radar-screen');
            radarScreen.querySelectorAll('.radar-dot, .radar-line').forEach(el => el.remove());
            
            const radarLine = document.createElement('div');
            radarLine.classList.add('radar-line');
            radarScreen.appendChild(radarLine);

            for (let i = 0; i < 8; i++) { 
                const dot = document.createElement('div');
                dot.classList.add('radar-dot');
                dot.style.top = `${Math.random() * 80 + 10}%`; 
                dot.style.left = `${Math.random() * 80 + 10}%`; 
                if (Math.random() > 0.6) dot.classList.add('threat'); 
                
                dot.style.animationDelay = `${Math.random() * 1}s`; 
                dot.style.animationDuration = `${Math.random() * 0.5 + 1}s`;

                radarScreen.appendChild(dot);
            }
        }

        // 5. CORE CONTROL HANDLERS (UPDATED FOR BACKEND COMMUNICATION)
        
        async function startAnalysis() {
            if (analysisRunning) return writeLog("Analysis already running.", 'error');

            analysisRunning = true;
            document.getElementById('system_status').textContent = 'ANALYSIS IN PROGRESS';
            document.getElementById('radar_status').textContent = 'REQUESTING...';
            
            writeLog("Sending POST request to start analysis...", 'info');

            try {
                // *** THE CRITICAL FIX: The fetch API call to your Flask backend ***
                const response = await fetch('/start_analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // You can send data here if your backend needed it (e.g., capture time)
                    body: JSON.stringify({ action: 'start' }) 
                });

                const data = await response.json();

                if (response.ok) {
                    writeLog(`Backend Status: ${data.status.toUpperCase()}`, 'info');
                    writeLog(`Detection Result: ${data.detection_status}`, data.detection_status === 'TOR' ? 'error' : 'success');
                    
                    // Start front-end dynamic displays (assuming analysis is finished)
                    startFrontendDisplays();
                    
                    // --- Update Dashboard Metrics (using dummy data if real not available) ---
                    document.getElementById('threats_val').textContent = data.report?.detections?.length || 'N/A';
                    document.getElementById('tor_val').textContent = data.report?.statistics?.unique_entries || 'N/A';
                    // The other metrics would be updated similarly from the 'data.report' object
                    
                    document.getElementById('system_status').textContent = 'ANALYSIS COMPLETE';
                    document.getElementById('radar_status').textContent = 'REPORTING';

                } else {
                    throw new Error(data.msg || `Server responded with status ${response.status}`);
                }

            } catch (error) {
                writeLog(`FATAL ERROR: ${error.message}`, 'error');
                writeLog("Analysis aborted.", 'error');
                stopAnalysis(); // Clean up frontend state
            }
        }

        function startFrontendDisplays() {
            analysisRunning = true;
            document.getElementById('radar_status').textContent = 'MONITORING';
            document.getElementById('radar_status').style.color = 'var(--accent-green)';
            
            if (!radarInterval) radarInterval = setInterval(updateRadarDots, 2000);
            if (!dataSimulationInterval) dataSimulationInterval = setInterval(simulateDataRefresh, 1500);
            
            // Initial calls
            simulateDataRefresh();
            updateRadarDots();
        }

        function stopAnalysis() {
            if (!analysisRunning) return;
            analysisRunning = false;
            
            document.getElementById('system_status').textContent = 'SYSTEM STANDBY';
            document.getElementById('radar_status').textContent = 'INACTIVE';
            document.getElementById('radar_status').style.color = 'var(--error-red)';
            
            clearInterval(radarInterval);
            clearInterval(dataSimulationInterval);
            radarInterval = null;
            dataSimulationInterval = null;
            
            // Reset simulated values
            document.querySelectorAll('.data-fill').forEach(bar => { bar.style.width = '0%'; });
            document.querySelector('.radar-screen').querySelectorAll('.radar-dot, .radar-line').forEach(el => el.remove());
            
            writeLog("Analysis System Shut Down. All displays reset.", 'info');
        }

        // Initial calls upon load
        stopAnalysis(); // Initialize in OFF state
    </script>
</body>
</html>